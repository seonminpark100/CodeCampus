package com.lms.springboot.prof;

import java.io.File;

import org.springframework.ui.Model;
import org.springframework.util.ResourceUtils;
import org.springframework.web.bind.annotation.RequestParam;

import com.lms.springboot.jdbc.ProfDTO;
import com.lms.springboot.utils.MyFunctions;

import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.Part;

public class fileUpload
{
	public String fileUploading(@RequestParam("lectureCode") String lecture_code, HttpServletRequest req, Model model, ProfDTO profDTO) {
		try
		{
			String uploadDir = ResourceUtils.getFile("classpath:static/uploads/")
					.toPath().toString();
			System.out.println("물리적경로:" + uploadDir);
			

			//전송된 첨부파일을 Part객체를 통해 얻어온다.
			Part part = req.getPart("ofile");
			//파일명 확인을 위해 헤더값을 얻어온다. 
			String partHeader = part.getHeader("content-disposition");
			System.out.println("partHeader=" + partHeader);

			//헤더값에서 파일명을 추출하기 위해 문자열을 split()한다. 
			String[] phArr = partHeader.split("filename=");
			//따옴표를 제거해서 원본파일명을 추출한다.  
			String originalFileName = phArr[1].trim().replace("\"", "");
			 //전송된 파일이 있다면 서버에 저장한다.
			if (!originalFileName.isEmpty())
			{
				part.write(uploadDir + File.separator + originalFileName);
			}
			
			//서버에 저장된 파일명을 UUID를 통해 생성된 이름으로 변경한다. 
			String savedFileName = MyFunctions.renameFile(uploadDir, originalFileName);
			
			model.addAttribute("originalFileName", originalFileName);
			model.addAttribute("savedFileName", savedFileName);
			model.addAttribute("user_id", req.getParameter("user_id"));
			model.addAttribute("lecture_code", req.getParameter("lecture_code"));
			model.addAttribute("board_title", req.getParameter("board_title"));
			model.addAttribute("board_content", req.getParameter("board_content"));
			model.addAttribute("category", req.getParameter("category"));
			
			//DB입력 (JDBC연동)
			profDTO.setOfile(originalFileName);
			profDTO.setSfile(savedFileName);
			int result =  dao.insertLectureWithFile(profDTO);
//			if(result==1) System.out.println("입력성공");
//			else System.out.println("입력실패");
			
		} catch (Exception e)
		{
			System.out.println("업로드 실패");
			e.printStackTrace();
		}
		
	}
}
